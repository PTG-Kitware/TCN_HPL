#
# System configuration to run the ANGEL system for the BBN system.
#
# This configuration is for the M2 tourniquet task.
#

name: R18-Chest-Seal
root: <%= ENV["ANGEL_WORKSPACE_DIR"] %>

# Optional tmux socket
# socket_name: foo

# Note that the pre and post options have been deprecated and will be replaced by
# project hooks.

# Project hooks

# Runs on project start, always
# on_project_start: command
on_project_start: |
    export ROS_NAMESPACE=${ROS_NAMESPACE:-/kitware}
    export HL2SS_API_URL=${HL2SS_API_URL:-128.33.193.178:8000}
    export BBN_OUTPUT_URL=${BBN_OUTPUT_URL:-tcp://128.33.193.178:6667}
    export CONFIG_DIR=${ANGEL_WORKSPACE_DIR}/config
    export NODE_CONFIG_DIR=${ANGEL_WORKSPACE_DIR}/src/angel_system_nodes/configs
    export MODEL_DIR=${ANGEL_WORKSPACE_DIR}/model_files
# Run on project start, the first time
# on_project_first_start: command

# Run on project start, after the first time
# on_project_restart: command

# Run on project exit ( detaching from tmux session )
# on_project_exit: command

# Run on project stop
# on_project_stop: command

# Runs in each window and pane before window/pane specific commands. Useful for setting up interpreter versions.
# pre_window: rbenv shell 2.0.0-p247

# Pass command line options to tmux. Useful for specifying a different tmux.conf.
# tmux_options: -f ~/.tmux.mac.conf
tmux_options: -f <%= ENV["ANGEL_WORKSPACE_DIR"] %>/tmux/tmux.conf

windows:
# Connection with the HL2 app via HL2SS sensor data streaming and the
# ROS-TCP-Endpoint
    - sensor_input: ros2 run angel_system_nodes generate_images
    # - sensor_input: ros2 bag play ${ANGEL_WORKSPACE_DIR}/ros_bags/rosbag2_2024_04_02-19_57_59-R18_naked_mannequin_no_blue_tarp-timestamp_unconfident/rosbag2_2024_04_02-19_57_59_0.db3 

    - run_image_timestamp: ros2 run angel_system_nodes image_timestamp_relay --ros-args
        -p image_topic:=image_0 
        -p output_topic:=image_0_ts

    - pose_estimation: ros2 run angel_system_nodes pose_estimator --ros-args 
        -p image_topic:=image_0 
        -p det_topic:=pose_dets 
        -p pose_topic:=PatientPose 
        -p det_net_checkpoint:=${ANGEL_WORKSPACE_DIR}/model_files/models/pose_det_model.pth 
        -p pose_net_checkpoint:=${ANGEL_WORKSPACE_DIR}/model_files/models/pose_model.pth 
        -p det_config:=${ANGEL_WORKSPACE_DIR}/python-tpl/TCN_HPL/tcn_hpl/data/utils/pose_generation/configs/medic_pose.yaml 
        -p pose_config:=${ANGEL_WORKSPACE_DIR}/python-tpl/TCN_HPL/tcn_hpl/data/utils/pose_generation/configs/ViTPose_base_medic_casualty_256x192.py
        -p cuda_device_id:=0

    - objects_hands_detection: ros2 run angel_system_nodes object_hand_detector --ros-args 
        -p image_topic:=image_0 
        -p det_topic:=ObjectDetections2d 
        -p net_checkpoint:=${ANGEL_WORKSPACE_DIR}/model_files/models/r18_det.pt
        -p hand_net_checkpoint:=${ANGEL_WORKSPACE_DIR}/model_files/models/hands_model.pt

    - run_tcn: ros2 run angel_system_nodes activity_classifier_tcn --ros-args 
        -p image_ts_topic:=image_0_ts 
        -p det_topic:=ObjectDetections2d 
        -p pose_topic:=PatientPose 
        -p model_weights:=${ANGEL_WORKSPACE_DIR}/model_files/models/r18_tcn.ckpt 
        -p model_mapping:=${ANGEL_WORKSPACE_DIR}/model_files/data_mapping/r18_mapping.txt 
        -p model_det_label_mapping:=${ANGEL_WORKSPACE_DIR}/config/object_labels/medical/r18.json 
        -p act_topic:=activity_topic

    - task_monitor: ros2 run angel_system_nodes global_step_predictor --ros-args
        -p config_file:=${CONFIG_DIR}/tasks/multi-task-config-medical-r18.yaml
        -p activity_config_file:=${CONFIG_DIR}/activity_labels/r18.yaml
        -p task_state_topic:=TaskUpdates
        -p task_error_topic:=TaskErrors
        -p system_command_topic:=SystemCommands
        -p det_topic:=activity_topic
        -p model_file:=${ANGEL_WORKSPACE_DIR}/model_files/coco/r18_test_activity_preds.mscoco.json
        -p thresh_frame_count:=8
        -p deactivate_thresh_frame_count:=20
        -p threshold_multiplier_weak:=0.05
        -p threshold_frame_count_weak:=8
        -p step_mode:=broad
        -p query_task_graph_topic:=query_task_graph


    - BBN Interface:
        layout: even-vertical
        panes:
            - task-converter: ros2 run bbn_integration_py task_to_bbn_update --ros-args 
                -r __ns:=${ROS_NAMESPACE}
                -p task_update_topic:=TaskUpdates
                -p bbn_update_topic:=BBNUpdates
                -p task_graph_srv_topic:=query_task_graph
                -p config:=${CONFIG_DIR}/bbn_integration/m2_tourniquet.yml
            - zmq-publisher: ros2 run bbn_integration ZmqIntegrationClient --ros-args
                -r __ns:=${ROS_NAMESPACE}
                -p topic_update_msg:=BBNUpdates
                -p server_address:=${BBN_OUTPUT_URL}
